#!/bin/sh
VERSION="$(fgrep Version opengt.spec |cut -d ' ' -f2)"
RELEASE="$(fgrep Release opengt.spec |cut -d ' ' -f2)"
FILES="$(ls -1 $HOME/RPM/RPMS/noarch/*opengt*$VERSION-$RELEASE.*.rpm $HOME/RPM/RPMS/noarch/osolutions-webapps-agp-*$VERSION-$RELEASE.*.rpm)"

rpmbb opengt.spec || { echo "Build failed. Exit."; exit 1; }
rpm -q opengtd && sudo rpm -Uhv $FILES || sudo rpm -ihv $FILES
sudo service nginx restart

if [ "$1" = "server" ]; then
	ssh="ssh map.spo"
	$ssh 'sudo rm -f /tmp/*.rpm'
	rsync -av $FILES map.spo:/tmp/
	echo "Update rpm"
	$ssh 'sudo rpm -Uhv /tmp/*.rpm'
#	echo "Remove rpm"

	echo "Restart nginx"
	$ssh 'sudo service nginx restart'
	git push spo
fi
